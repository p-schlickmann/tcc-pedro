image: docker:27-cli

stages:
  - build
  - portainer
### BUILD
build:
  stage: build
  only:
    - master
    - main
    - tcc-pedro
  script:
    - docker build . -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"

#### DEPLOY
#
# Exige configuração no PORTAINER e GITLAB
#
# WEBHOOK_PORTAINER: Possui a URL para rebootar o Serviço em produção
# URL de Webhook será enviada pela SeTIC mediante requisição via chamado.
# Esta variável deve ser configurada no codigos.ufsc.br:
#  Dentro do projeto > Settings > CI/CD > Secret Variables
portainer:
  stage: portainer
  only:
    - master
    - main
  variables:
    GIT_CHECKOUT: "false"
  script:
          - if [[ ! -z "${WEBHOOK_PORTAINER}" ]]; then
            for url in $(echo ${WEBHOOK_PORTAINER} | sed "s/,/ /g"); do wget --post-data '' -O - "$url"; done
            else
              echo "Empty \$WEBHOOK_PORTAINER" ; exit 1;
            fi
